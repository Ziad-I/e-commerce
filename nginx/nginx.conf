events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    upstream user-service    { server user-service:8000; }
    upstream product-service { server product-service:8000; }
    upstream cart-service    { server cart-service:8000; }
    upstream search-service  { server search-service:8000; }

    map $1 $backend_upstream {
        users    user-service;
        products product-service;
        cart     cart-service;
        search   search-service;
    }

    server {
        listen    80;

        location ~ ^/api/v1/(?<service>[^/]+)/(?<tail>.*)$ {
            proxy_pass http://$backend_upstream/api/v1/$service/$tail$is_args$args;
            proxy_set_header Host              $host;
            proxy_set_header X-Real-IP         $remote_addr;
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
